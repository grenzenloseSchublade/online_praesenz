{% comment %}
  Erweiterung des Standard-TOC von Minimal Mistakes mit optionaler Ausklapp-Funktionalität.
  Diese Datei wird in _layouts/single.html eingebunden und ersetzt die direkte Einbindung von toc.html.
  
  Die Ausklapp-Funktionalität wird aktiviert, wenn in der Front Matter toc_collapse: true gesetzt ist.
  Alle anderen TOC-Parameter (toc_label, toc_icon, toc_sticky) funktionieren weiterhin wie gewohnt.
{% endcomment %}

{% assign toc_id_source = page.url | default: page.title | default: "toc" %}
{% assign toc_id = toc_id_source | slugify | prepend: "toc-" %}

<aside class="sidebar__right {% if page.toc_sticky %}sticky{% endif %}">
  <nav class="toc" aria-label="{{ page.toc_label | default: site.data.ui-text[site.locale].toc_label | default: "Inhalt" }}">
    {% if page.toc_collapse %}
      <button id="{{ toc_id }}-toggle" class="toc-toggle" type="button" aria-expanded="true" aria-controls="{{ toc_id }}-content">
        <h4 class="nav__title">
          <i class="fas fa-{{ page.toc_icon | default: 'file-alt' }}"></i> 
          {{ page.toc_label | default: site.data.ui-text[site.locale].toc_label | default: "Inhalt" }}
          <span class="toc-toggle-icon">▲</span>
        </h4>
      </button>
      <div id="{{ toc_id }}-content" class="toc__menu-wrapper">
        {% include toc.html sanitize=true html=content h_min=2 h_max=6 class="toc__menu" skip_no_ids=true %}
      </div>
    {% else %}
      <header><h4 class="nav__title"><i class="fas fa-{{ page.toc_icon | default: 'file-alt' }}"></i> {{ page.toc_label | default: site.data.ui-text[site.locale].toc_label | default: "Inhalt" }}</h4></header>
      {% include toc.html sanitize=true html=content h_min=2 h_max=6 class="toc__menu" skip_no_ids=true %}
    {% endif %}
  </nav>
</aside>

{% if page.toc_collapse %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tocToggle = document.getElementById('{{ toc_id }}-toggle');
  const tocContent = document.getElementById('{{ toc_id }}-content');
  
  if (!tocToggle || !tocContent) return;

  const storageKey = '{{ toc_id }}-state';
  const prefersReducedMotion = window.matchMedia
    ? window.matchMedia('(prefers-reduced-motion: reduce)').matches
    : false;

  let resizeRaf = null;

  const updateMaxHeight = function() {
    if (tocToggle.getAttribute('aria-expanded') === 'true') {
      tocContent.style.maxHeight = tocContent.scrollHeight + 'px';
    }
  };

  const setExpanded = function(isExpanded, persist) {
    tocToggle.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
    tocContent.classList.toggle('is-collapsed', !isExpanded);
    if (isExpanded) {
      updateMaxHeight();
    } else {
      tocContent.style.maxHeight = '0px';
    }

    if (persist !== false) {
      try {
        localStorage.setItem(storageKey, isExpanded ? 'expanded' : 'collapsed');
      } catch (error) {
        // localStorage not available, ignore
      }
    }
  };

  let storedState;
  try {
    storedState = localStorage.getItem(storageKey);
  } catch (error) {
    storedState = null;
  }

  const startExpanded = storedState !== 'collapsed';
  setExpanded(startExpanded, false);

  if (prefersReducedMotion) {
    tocContent.style.transition = 'none';
  }

  tocToggle.addEventListener('click', function() {
    const isExpanded = tocToggle.getAttribute('aria-expanded') === 'true';
    setExpanded(!isExpanded);
  });

  window.addEventListener('resize', function() {
    if (resizeRaf) {
      cancelAnimationFrame(resizeRaf);
    }
    resizeRaf = requestAnimationFrame(updateMaxHeight);
  });
});
</script>
{% endif %} 